---
title: "Rpath for Lake Champlain"
author: "Rosalie Bruel"
date: "19/09/2019"
output: 
  html_document:
    df_print: paged
    fig_caption: true
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
  df_print: paged
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = '#>',
  collapse = T)
#devtools::install_github("NOAA-EDAB/Rpath", dependencies = T)
#devtools::install_github('NOAA-EDAB/Rpath', build_vignettes = TRUE)
library(Rpath); library(data.table)

library(reshape) # melt diet table
library(wesanderson) # colors
library(igraph) # probably better for nodes graph because can also assign weigth
library(tidygraph) # to transform dataframe in node datasets


getpath4data <- function() {
  if(Sys.getenv("USER")=="Rosalie") return("/Volumes/-/Script R/LCM_GitHub_Data_LCM/")
  if(Sys.getenv("USER")=="alexnaccarato") return("~/Desktop/Food-Web 2018-2019/LCM_GitHub_Data/")
  if(Sys.getenv("USER")!="Rosalie"|Sys.getenv("USER")!="alexnaccarato") stop("You need to get the data.")
}

R_U_KNITTING = TRUE
```

# General documentation about Rpath
_Copied from <a href="https://rdrr.io/github/NOAA-EDAB/Rpath/f/vignettes/Rpath.Rmd"> here</a>, because I don't know how stable the link is._
<br>
Rpath is an implementation of the ecosystem model Ecopath with Ecosim (EwE; Christensen and Pauly 1992^[Christensen and Pauly. 1992. ECOPATH II - a software for balancing steady-state models and calculating network characteristics. Ecological Modelling 61:169-85], Walters et al. 1997^[Walters et al. 1997. Structuring dynamic models of exploited ecosystems from trophic mass-balance assessments. Reviews of Fish Biology and Fisheries 7:1-34]). This vignette describes some of the basic functionality of the package using a fictional ecosystem, R Ecosystem. Any resemblance to an actual ecosystem is purely coincidental. To see the underlying mathematics please refer to Lucey et al. (in prep^[Lucey et al. in prep. Improving the EBFM toolbox with an alternative open source version of Ecopath with Ecosim]).


## Setting up Ecopath

### Parameter file generation
Unlike the GUI based EwE software package, Rpath relies on a parameter input file.
This file is actually a list of several different parameter files: model, diet, 
stanzas, and pedigree.  Parameter files can be created outside of R and read in using
the `read.rpath.params` function.  This function will merge several different flat
files into an R object of the list type.  A preferred alternative is to generate 
the list file and populate it completely within R.  The function 
`create.rpath.params` will generate an Rpath.param.  This ensures that all 
of the correct columns are present in the parameter file.

The parameter file contains all of the information you would normally enter in the
input data tabs in EwE.  There are 2 necessary pieces of information to generate
the parameter file: the group names and their corresponding type.  The types are:
living = 0, primary producer = 1, detritus = 2, and fleet = 3.  If your model 
contains multi-stanza groups then you need 2 additional pieces of information: 
stanza group names (include NA for those groups not in a stanza) and the number of
stanzas per stanza group.

```
#Groups and types for the R Ecosystem

groups <- c('Seabirds', 'Whales', 'Seals', 'JuvRoundfish1', 'AduRoundfish1', 
            'JuvRoundfish2', 'AduRoundfish2', 'JuvFlatfish1', 'AduFlatfish1',
            'JuvFlatfish2', 'AduFlatfish2', 'OtherGroundfish', 'Foragefish1',
            'Foragefish2', 'OtherForagefish', 'Megabenthos', 'Shellfish',
            'Macrobenthos', 'Zooplankton', 'Phytoplankton', 'Detritus', 
            'Discards', 'Trawlers', 'Midwater', 'Dredgers')

types  <- c(rep(0, 19), 1, rep(2, 2), rep(3, 3))

stgroups <- c(rep(NA, 3), rep('Roundfish1', 2), rep('Roundfish2', 2), 
              rep('Flatfish1', 2), rep('Flatfish2', 2), rep(NA, 14))

REco.params <- create.rpath.params(group = groups, type = types, stgroup = stgroups)
```


REco.params now contains a list of 4 objects: model, diet, stanzas, and pedigree. The majority of the parameters are populated with NA save those that have logical default vaules (i.e 0.66667 for VBGF_d).

### Model parameters

The model parameter list contains the biomass, production to biomass, consumption to biomass, etc. parameters as well as the detrital fate parameters and fleet landings and discards.

```knitr::kable(REco.params$model, caption = 'Example of the model list created using the `create.rpath.param` function')```

Each of the parameter lists are data tables (With the exception of the stanzas list which is itself a list of an integer and two data tables). Data tables are an extension of the classic data frame class. Advantages of data tables include simplified indexing which eases the process of populating the parameters. For example you can add data to a specific slot or fill an entire column.

```
#Example of filling specific slots
REco.params$model[Group %in% c('Seals', 'Megabenthos'), EE := 0.8]

#Example of filling an entire column
biomass <- c(0.0149, 0.454, NA, NA, 1.39, NA, 5.553, NA, 5.766, NA,
             0.739, 7.4, 5.1, 4.7, 5.1, NA, 7, 17.4, 23, 10, rep(NA, 5))
REco.params$model[, Biomass := biomass]
```

Note the use of the operator ':=' to assign values. This is unique to data tables.

```knitr::kable(REco.params$model[, list(Group, Type, Biomass, EE)], caption = 'Example of assigning a specific slot or a whole column')```

Here are the rest of the columns for the model list.

```
#Model
biomass <- c(0.0149, 0.454, NA, NA, 1.39, NA, 5.553, NA, 5.766, NA,
             0.739, 7.4, 5.1, 4.7, 5.1, NA, 7, 17.4, 23, 10, rep(NA, 5))

pb <- c(0.098, 0.031, 0.100, 2.026, 0.42, 2.1, 0.425, 1.5, 0.26, 1.1, 0.18, 0.6,
        0.61, 0.65, 1.5, 0.9, 1.3, 7, 39, 240, rep(NA, 5))

qb <- c(76.750, 6.976, 34.455, NA, 2.19, NA, 3.78, NA, 1.44, NA, 1.69,
        1.764, 3.52, 5.65, 3.6, 2.984, rep (NA, 9))

REco.params$model[, Biomass := biomass]
REco.params$model[, PB := pb]
REco.params$model[, QB := qb]

#EE for groups w/o biomass
REco.params$model[Group %in% c('Seals', 'Megabenthos'), EE := 0.8]

#Production to Consumption for those groups without a QB
REco.params$model[Group %in% c('Shellfish', 'Zooplankton'), ProdCons:= 0.25]
REco.params$model[Group == 'Macrobenthos', ProdCons := 0.35]

#Biomass accumulation and unassimilated consumption
REco.params$model[, BioAcc  := c(rep(0, 22), rep(NA, 3))]
REco.params$model[, Unassim := c(rep(0.2, 18), 0.4, rep(0, 3), rep(NA, 3))]

#Detrital Fate
REco.params$model[, Detritus := c(rep(1, 20), rep(0, 5))]
REco.params$model[, Discards := c(rep(0, 22), rep(1, 3))]

#Fisheries
#Landings
trawl  <- c(rep(0, 4), 0.08, 0, 0.32, 0, 0.09, 0, 0.05, 0.2, rep(0, 10), rep(NA, 3))
mid    <- c(rep(0, 12), 0.3, 0.08, 0.02, rep(0, 7), rep(NA, 3))
dredge <- c(rep(0, 15), 0.1, 0.5, rep(0, 5), rep(NA, 3))
REco.params$model[, Trawlers := trawl]
REco.params$model[, Midwater := mid]
REco.params$model[, Dredgers := dredge]

#Discards
trawl.d  <- c(1e-5, 1e-7, 0.001, 0.001, 0.005, 0.001, 0.009, 0.001, 0.04, 0.001,
              0.01, 0.08, 0.001, 0.001, 0.001, rep(0, 7), rep(NA, 3))
mid.d    <- c(rep(0, 2), 0.001, 0.001, 0.01, 0.001, 0.01, rep(0, 4), 0.05, 0.05,
              0.01, 0.01, rep(0, 7), rep(NA, 3))
dredge.d <- c(rep(0, 3), 0.001, 0.05, 0.001, 0.05, 0.001, 0.05, 0.001, 0.01, 0.05,
              rep(0, 3), 0.09, 0.01, 1e-4, rep(0, 4), rep(NA, 3))
REco.params$model[, Trawlers.disc := trawl.d]
REco.params$model[, Midwater.disc := mid.d]
REco.params$model[, Dredgers.disc := dredge.d]
```

```
knitr::kable(REco.params$model, 
             caption = 'Example of completed model list')
```

### Stanza Parameters

You may have noticed that the biomass and consumption to biomass parameters are missing from some of the multistanza groups. Similar to EwE, Rpath calculates those parameters to ensure that stanza groups support one another (Christensen and Walters 2004^[Christensen and Walters. 2004. Ecopath with Ecosim: methods, capabilities and limitations. Ecological Modelling 172:109-139]). In order to do this, you need to populate the stanza list. As mentioned earlier, this is actually a list itself containing 3 things: the number of stanza groups, stanza group parameters, and individual stanza parameters. The number of stanzas is automatically populated. For stanza groups you need their von Bertalanffy growth function specialized K and weight at 50% maturity divided by their weight infinity (relative weight at maturity). Individual stanzas need the first and last month the species is in the stanza, the total mortality (Z) on the stanza, and whether or not it is the leading stanza.

```
#Group parameters
REco.params$stanzas$stgroups[, VBGF_Ksp := c(0.145, 0.295, 0.0761, 0.112)]
REco.params$stanzas$stgroups[, Wmat     := c(0.0769, 0.561, 0.117,  0.321)]

#Individual stanza parameters
REco.params$stanzas$stindiv[, First   := c(rep(c(0, 24), 3), 0, 48)]
REco.params$stanzas$stindiv[, Last    := c(rep(c(23, 400), 3), 47, 400)]
REco.params$stanzas$stindiv[, Z       := c(2.026, 0.42, 2.1, 0.425, 1.5, 
                                           0.26, 1.1, 0.18)]
REco.params$stanzas$stindiv[, Leading := rep(c(F, T), 4)]
```
```
knitr::kable(REco.params$stanzas$stgroups)
knitr::kable(REco.params$stanzas$stindiv)
```

The final month of the ultimate stanza can be set to any value. The function rpath.stanzas will calculate the final month as the point where the species reaches 90% Winf. The function rpath.stanzas will also add data tables containing the weight, number, and consumption at age for each stanza group.

```REco.params <- rpath.stanzas(REco.params)```
```
knitr::kable(REco.params$stanzas$stanzas, caption = 'Completed stanzas table')
knitr::kable(head(REco.params$stanzas$StGroup[[1]]), 
             caption = 'Example of the StGroup data table')
             ```
Output from the rpath.stanzas function can be plotted using the stanzaplot function.

```stanzaplot(REco.params, StanzaGroup = 1)```

Note: If you do not have multistanza groups in your model, you do not have to run rpath.stanzas.

### Diet Parameters

The data entered in the diet list is the same as the data entered in the diet composition tab in EwE. Just as within EwE, the columns represent the predators while the rows represent the prey. Individual diet components can be adjusted by specifying the prey in the 'Group' variable and assigning a value to the predator. For example, if you wanted to assign 10% of the seabird diet as 'Other Groundfish' you could do it like this:

```
REco.params$diet[Group == 'OtherGroundfish', Seabirds := 0.1]
```
You can also assign the entire diet composition for a predator:

```
whale.diet <- c(rep(NA, 3), 0.01, NA, 0.01, NA, 0.01, NA, 0.01, rep(NA, 4), 0.1,
                rep(NA, 3), 0.86, rep(NA, 3), NA)

REco.params$diet[, Whales := whale.diet]
```
```knitr::kable(REco.params$diet[, list(Group, Seabirds, Whales)])```

Here is the completed model parameter file for R Ecosystem:

```
REco.params$diet[, Seabirds        := c(rep(NA, 11), 0.1, 0.25, 0.2, 0.15, 
                                        rep(NA, 6), 0.3, NA)]
REco.params$diet[, Whales          := c(rep(NA, 3), 0.01, NA, 0.01, NA, 0.01, 
                                        NA, 0.01, rep(NA, 4), 0.1, rep(NA, 3), 
                                        0.86, rep(NA, 3), NA)]
REco.params$diet[, Seals           := c(rep(NA, 3), 0.05, 0.1, 0.05, 0.2, 0.005, 
                                        0.05, 0.005, 0.01, 0.24, rep(0.05, 4), 
                                        0.09, rep(NA, 5), NA)]
REco.params$diet[, JuvRoundfish1   := c(rep(NA, 3), rep(c(1e-4, NA), 4), 1e-3, 
                                        rep(NA, 2), 0.05, 1e-4, NA, .02, 0.7785, 
                                        0.1, 0.05, NA, NA)]
REco.params$diet[, AduRoundfish1   := c(rep(NA, 5), 1e-3, 0.01, 1e-3, 0.05, 1e-3, 
                                        0.01, 0.29, 0.1, 0.1, 0.347, 0.03, NA, 
                                        0.05, 0.01, rep(NA, 3), NA)]
REco.params$diet[, JuvRoundfish2   := c(rep(NA, 3), rep(c(1e-4, NA), 4), 1e-3, 
                                        rep(NA, 2), 0.05, 1e-4, NA, .02, 0.7785, 
                                        0.1, .05, NA, NA)]
REco.params$diet[, AduRoundfish2   := c(rep(NA, 3), 1e-4, NA, 1e-4, NA, rep(1e-4, 4), 
                                        0.1, rep(0.05, 3), 0.2684, 0.01, 0.37, 0.001, 
                                        NA, 0.1, NA, NA)]
REco.params$diet[, JuvFlatfish1    := c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 3), 
                                        rep(1e-4, 2), NA, 0.416, 0.4334, 0.1, 0.05, 
                                        NA, NA)]
REco.params$diet[, AduFlatfish1    := c(rep(NA, 7), rep(1e-4, 5), rep(NA, 2), 0.001, 
                                        0.05, 0.001, 0.6, 0.2475, NA, 0.1, NA, NA)]
REco.params$diet[, JuvFlatfish2    := c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 3),
                                        rep(1e-4, 2), NA, 0.416, 0.4334, 0.1, 0.05, 
                                        NA, NA)]
REco.params$diet[, AduFlatfish2    := c(rep(NA, 7), 1e-4, NA, 1e-4, rep(NA, 4), 
                                        rep(1e-4, 3), 0.44, 0.3895, NA, 0.17, NA, NA)]
REco.params$diet[, OtherGroundfish := c(rep(NA, 3), rep(1e-4, 8), 0.05, 0.08, 0.0992, 
                                        0.3, 0.15, 0.01, 0.3, 0.01, rep(NA, 3), NA)]
REco.params$diet[, Foragefish1     := c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 7), 
                                        0.8196, 0.06, 0.12, NA, NA)]
REco.params$diet[, Foragefish2     := c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 7), 
                                        0.8196, 0.06, 0.12, NA, NA)]
REco.params$diet[, OtherForagefish := c(rep(NA, 3), rep(c(1e-4, NA), 4), rep(NA, 7), 
                                        0.8196, 0.06, 0.12, NA, NA)]
REco.params$diet[, Megabenthos     := c(rep(NA, 15), 0.1, 0.03, 0.55, rep(NA, 2), 0.32,
                                        NA, NA)]
REco.params$diet[, Shellfish       := c(rep(NA, 18), 0.3, 0.5, 0.2, NA, NA)]
REco.params$diet[, Macrobenthos    := c(rep(NA, 16), 0.01, rep(0.2, 2), NA, 0.59, NA, NA)]
REco.params$diet[, Zooplankton     := c(rep(NA, 18), 0.2, 0.6, 0.2, NA, NA)]
```

```knitr::kable(REco.params$diet, caption = 'Diet parameters for R Ecosystem')```

### Pedigree parameters

Rpath does not currently use pedigrees however, future Rpath extensions will use them. Therefore we include them in the current parameter object. The default values are 1 (low confidence). These defaults are not changed for R Ecosystem but can obviously be changed in a similar manner to the other parameter files.

```knitr::kable(REco.params$pedigree, caption = 'Pedigree parameters for R Ecosystem')```

##Running Ecopath

After creating the parameter object, running ecopath in R is relatively straightforward. It is just the function rpath supplied with the parameter object. Additionally, you can supply an ecosystem name for the output.

```
REco <- rpath(REco.params, eco.name = 'R Ecosystem')
REco
```
The output object from rpath is an S3 object type called 'Rpath'. Rpath objects are a list of parameters from the mass balance. However, the print function will display the same information as the "Basic Estimates" tab from EwE. You will also notice that the print function will display whether the model is balanced or not. If the model was not balanced, it would list the groups that are not balanced.

You can also display the mortalities associated with each group by supplying the argument morts = T to the print function.

```print(REco, morts = T)```

Note that if you wish to save the print output you need to use the function write.rpath. This function will also accept the argument 'morts = T'.

The generic function summary will display some summary statistics on the model as well as a list of attributes you can access. To access any of the other attributes simply use the standard list notation.

```
summary(REco)
REco$TL
```
One of the advantages of R is its graphical ability. Users can feel free to develop their own graphical routines for the Rpath outputs. However, we have included a basic food web plot. The routine can include fisheries, display group numbers or names, and even highlight a particular group.

```
webplot(REco)
webplot(REco, labels = T)
webplot(REco, fleets = T, highlight = 'AduRoundfish1')
```

# Lake Champlain

## Setting up parameters for Lake Champlain

### Parameter file generation

```{r parameter file generation lake champlain, echo=TRUE, message=FALSE, warning=FALSE}
groups <- c('Sea Lamprey', 'Stocked lake trout','Juvenile lake trout', 'Adult lake trout', 'Atlantic salmon', 'Burbot', 'Walleye', 'Whitefish', 'Cisco', 'Smelt', 'Alewife', 'Trout-perch', 'Sculpin', 'Zoo (predacious)', 'Mysis', 'Benthic invertebrates', 'Zoo grazers', 'Phytoplankton', 'Detritus', 'Fleet1')
# type 1= primary producer
# type 2= detritus
# type 3= fleet
# type 0= consumer (the rest)
types  <- c(rep(0, length(groups)-3), 1, 2,3)

stgroups <- c(rep(NA, 1), rep('LakeTrout', 3), rep(NA, 15),NA)

REco.params.LC <- create.rpath.params(group = groups, type = types, stgroup = stgroups)
```

Below is the data frame we're going to populate.

```{r echo=FALSE}
knitr::kable(REco.params.LC$model, caption = 'Model list created using the `create.rpath.param` function')
```


### Model parameters

#### Biomass

```{r}
M_fish <- read.delim(paste0(getpath4data(),"EwE_params/M_fish.txt"))

# REco.params.LC$model[Group %in% c('Sea Lamprey'), Biomass := .2]
# REco.params.LC$model[Group %in% c('Adult lake trout'), Biomass := 2]
# REco.params.LC$model[Group %in% c('Juvenile lake trout'), Biomass := 85]
REco.params.LC$model[Group %in% c('Stocked lake trout'), Biomass := 85]
# REco.params.LC$model[Group %in% c('Atlantic salmon'), Biomass := 27]
# REco.params.LC$model[Group %in% c('Burbot'), Biomass := 10]
# REco.params.LC$model[Group %in% c('Walleye'), Biomass := 12]
# REco.params.LC$model[Group %in% c('Whitefish'), Biomass := 40]
# REco.params.LC$model[Group %in% c('Cisco'), Biomass := 45]
# REco.params.LC$model[Group %in% c('Smelt'), Biomass := 45]
# REco.params.LC$model[Group %in% c('Alewife'), Biomass := 12]
# REco.params.LC$model[Group %in% c('Trout-perch'), Biomass := 80]
# REco.params.LC$model[Group %in% c('Sculpin'), Biomass := 120]
# REco.params.LC$model[Group %in% c('Benthic invertebrates'), Biomass := 400]
# REco.params.LC$model[Group %in% c('Zoo (predacious)'), Biomass := 300]
# REco.params.LC$model[Group %in% c('Zoo grazers'), Biomass := 500]
# REco.params.LC$model[Group %in% c('Mysis'), Biomass := 0.4] # 0.4 g/m2 estimated from Jason's density data, and Rosie's weight data from Cheasapeake Bay. Biomass prior to 1995 was 1.2 g/m2. g/m2 and t/km2 is the same. Kitchell et al have a biomass of 0.18494 g/m2 for Lake Superior.
 REco.params.LC$model[Group %in% c('Phytoplankton'), Biomass := 700*9000]

```


#### P/B

```{r}
M_fish <- read.delim(paste0(getpath4data(),"EwE_params/M_fish.txt"))


REco.params.LC$model[Group %in% c('Sea Lamprey'), PB := M_fish$sea_lamprey]
REco.params.LC$model[Group %in% c('Adult lake trout'), PB := M_fish$lake_trout_ad]
REco.params.LC$model[Group %in% c('Juvenile lake trout'), PB := M_fish$lake_trout_juv-0.2]
REco.params.LC$model[Group %in% c('Stocked lake trout'), PB := M_fish$lake_trout_stk]
REco.params.LC$model[Group %in% c('Atlantic salmon'), PB := M_fish$atlantic_salmon]
REco.params.LC$model[Group %in% c('Burbot'), PB := M_fish$burbot]
REco.params.LC$model[Group %in% c('Walleye'), PB := M_fish$walleye]
REco.params.LC$model[Group %in% c('Whitefish'), PB := M_fish$whitefish]
REco.params.LC$model[Group %in% c('Cisco'), PB := M_fish$cisco]
REco.params.LC$model[Group %in% c('Smelt'), PB := M_fish$smelt+0.3] # increasing production rate for smelt to see if the model calculates a lower biomass 
REco.params.LC$model[Group %in% c('Alewife'), PB := M_fish$alewife+0.1] # increasing production rate for smelt to see if the model calculates a lower biomass
REco.params.LC$model[Group %in% c('Trout-perch'), PB := M_fish$trout_perch]
REco.params.LC$model[Group %in% c('Sculpin'), PB := M_fish$sculpin]
REco.params.LC$model[Group %in% c('Sculpin'), PB := .3] # random value for now
REco.params.LC$model[Group %in% c('Benthic invertebrates'), PB := 3]
REco.params.LC$model[Group %in% c('Zoo (predacious)'), PB := 13]
REco.params.LC$model[Group %in% c('Zoo grazers'), PB := 13+32] # Increasing production rate from 13 to 45 to see if the model calculates a lower biomass 
REco.params.LC$model[Group %in% c('Mysis'), PB := 3]
REco.params.LC$model[Group %in% c('Phytoplankton'), PB := 300]
REco.params.LC$model[Group %in% c('Fleet1'), PB := NA]

```

#### Q/B

```{r}
QB_fish <- read.delim(paste0(getpath4data(),"EwE_params/QB_fish.txt"))


REco.params.LC$model[Group %in% c('Sea Lamprey'), QB := QB_fish$sea_lamprey]
REco.params.LC$model[Group %in% c('Adult lake trout'), QB := QB_fish$lake_trout_ad]
REco.params.LC$model[Group %in% c('Juvenile lake trout'), QB := QB_fish$lake_trout_juv]
REco.params.LC$model[Group %in% c('Stocked lake trout'), QB := QB_fish$lake_trout_stk]
REco.params.LC$model[Group %in% c('Atlantic salmon'), QB := QB_fish$atlantic_salmon]
REco.params.LC$model[Group %in% c('Burbot'), QB := QB_fish$burbot]
REco.params.LC$model[Group %in% c('Walleye'), QB := QB_fish$walleye]
REco.params.LC$model[Group %in% c('Whitefish'), QB := QB_fish$whitefish]
REco.params.LC$model[Group %in% c('Cisco'), QB := QB_fish$cisco]
REco.params.LC$model[Group %in% c('Smelt'), QB := QB_fish$smelt]
REco.params.LC$model[Group %in% c('Alewife'), QB := QB_fish$alewife]
REco.params.LC$model[Group %in% c('Trout-perch'), QB := QB_fish$trout_perch]
REco.params.LC$model[Group %in% c('Sculpin'), QB := QB_fish$sculpin]
# I think I entered the number below by mistake, trying to mimic the Rpath_example
# No Q/B calculated for these, groups, use ProdCons instead
# REco.params.LC$model[Group %in% c('Benthic invertebrates'), QB := 13]
# REco.params.LC$model[Group %in% c('Zoo (predacious)'), QB := 200]
# REco.params.LC$model[Group %in% c('Zoo grazers'), QB := 365]
# REco.params.LC$model[Group %in% c('Mysis'), QB := 20]
# REco.params.LC$model[Group %in% c('Fleet1'), QB := 0]

```

#### PQ for groups without a QB

```{r}
#Production to Consumption for those groups without a QB
#REco.params.LC$model[Group %in% c('Zooplankton'), ProdCons:= 0.25]
REco.params.LC$model[Group %in% c('Benthic invertebrates',
                                  'Zoo (predacious)',
                                  'Zoo grazers',
                                  'Mysis'), ProdCons := .25]
REco.params.LC$model[Group == 'Phytoplankton', ProdCons := 0.60]
```

#### Biomass accumulation and unassimilated consumption

```{r}
#Biomass accumulation and unassimilated consumption
REco.params.LC$model[, BioAcc  := c(rep(0, 19), rep(NA, 1))]
REco.params.LC$model[, Unassim := c(rep(0.2, 13), rep(0.4,4), rep(0, 2), rep(NA, 1))]

```



#### EE

```{r}

# Method 1: Use same data everywhere
REco.params.LC$model$EE <- rep(0.1, length(REco.params.LC$model$EE))
REco.params.LC$model$EE <- rep(NA, length(REco.params.LC$model$EE))

# Method 2: Change to the same value only when one of Biomass, PB or QB is missing
for (i in 1:length(REco.params.LC$model$EE)) {
  if (any(is.na(REco.params.LC$model[i, c("Biomass", "PB","QB")]))) {
    #REco.params.LC$model$EE[i] = 0.1
    print(REco.params.LC$model$Group[i])
  }
}


# Method 3: put some values that are more likely to match reality.
REco.params.LC$model$EE <- as.numeric(paste(REco.params.LC$model$EE))
# BUT, values reported vary A LOT according to different studies. Sometimes, they vary because age-class changes (make sense), but a lot of times, I don't understand the reasons behind having these parameters vary that much.
REco.params.LC$model[Group %in% c('Sea Lamprey'), EE := 0] #(Kao et al., 2016 Lake Huron)
#REco.params.LC$model[Group %in% c('Adult lake trout'), EE := .83] # For fish age 0-0.5 year Kao et al., 2016 (Lake Huron)
#REco.params.LC$model[Group %in% c('Juvenile lake trout'), EE := 0.12] # For fish age 1-4 years Kao et al., 2016 (Lake Huron)
#REco.params.LC$model[Group %in% c('Stocked lake trout'), EE := 0.1] # For fish age 5+ year Kao et al., 2016 (Lake Huron)
REco.params.LC$model[Group %in% c('Atlantic salmon'), EE := .1]
REco.params.LC$model[Group %in% c('Burbot'), EE := 0.41] #Kao et al 2016 Lake Huron, for Burbot 1+ 
REco.params.LC$model[Group %in% c('Walleye'), EE := 0.83] # Zhang et al., 2016 (Lake Erie)
REco.params.LC$model[Group %in% c('Whitefish'), EE := .4] #Average values for Lake Huron (Kao et al 2016) are around .2, but average values for Lac La Biche (McGregor et al 2015) are much higher (~.6)
REco.params.LC$model[Group %in% c('Cisco'), EE := .4] # no data. With .1, biomass always underestimated
REco.params.LC$model[Group %in% c('Smelt'), EE := .8] # Average values vary a lot for smelt in the litterature... 
REco.params.LC$model[Group %in% c('Alewife'), EE := .3] # values reported for several lakes, and again, really high variability.
REco.params.LC$model[Group %in% c('Trout-perch'), EE := .61] # only one data reported in the literature reviewed Kao et al., 2014 (Lake Huron)
REco.params.LC$model[Group %in% c('Sculpin'), EE := .57] # Kao et al., 2018 (Lake Michigan)
REco.params.LC$model[Group %in% c('Benthic invertebrates'), EE := 0.46] # 0.46 in Lake Huron (Kao et al., 2014)
REco.params.LC$model[Group %in% c('Zoo (predacious)'), EE := .8] # 0.82 for Bythotrephes (Kao et al., 2018, Lake Michigan). 0.87 for predatory cladoceran (Kao et al., 2016, Lake Huron), but also .42 and .3 in the same lake?
REco.params.LC$model[Group %in% c('Zoo grazers'), EE := .7] #0.23 for Herbivorous cladocerans Zhang et al., 2016 (Lake Erie). Value much higher when all groups are considered together, while individually, they are smaller. Trying a random higher value .7
REco.params.LC$model[Group %in% c('Mysis'), EE := .95] # In Rogers et al 2014 for Lake Michigan
REco.params.LC$model[Group %in% c('Phytoplankton'), EE := 0.75] # 0.75 for Kitchell et al., 2000, Lake Superior, 0.79 for Kao et al 2018 (Lake Michigan). There is some edible and non-edible phytoplankton
REco.params.LC$model[Group %in% c('Detritus'), EE := 0.1] # depends on settled/pelagic/sedimented detritus. Higher values for pelagic detritus. Here, I'm using values in the range of those reported for settled detritus in Lake Huron (Kao et al, 2016)

# Fleet1 are not living and should not have a EE...set to NA 
REco.params.LC$model[Group %in% c('Fleet1'), EE := NA]


```

#### Detrital Fate

```{r}
REco.params.LC$model[, Detritus := c(rep(1, 18), rep(0, 2))]
REco.params.LC$model[, Discards := c(rep(0, 19), 1)]
```


#### Fisheries
No fisheries, but it seems that the model needs to have at least one fleet?
```{r}
# Landing
REco.params.LC$model[, Fleet1 := c(rep(0, (nrow(REco.params.LC$model)-1)),NA)]

#Discards
REco.params.LC$model[, Fleet1.disc := c(rep(0, (nrow(REco.params.LC$model)-1)), NA)]

```


#### Stanza parameters

We need to populate the stanza list. This is actually a list itself containing 3 things: the number of stanza groups, stanza group parameters, and individual stanza parameters. The number of stanzas is automatically populated. For stanza groups, we need their von Bertalanffy growth function specialized K and weight at 50% maturity divided by their weight infinity (relative weight at maturity). Individual stanzas need the first and last month the species is in the stanza, the total mortality (Z) on the stanza, and whether or not it is the leading stanza.

```{r stanzas data}
REco.params.LC$stanzas$stgroups
REco.params.LC$stanzas$stindiv
REco.params.LC$stanzas$NStanzaGroups
```


```{r populate stanzas data}
#Group parameters
REco.params.LC$stanzas$stgroups[, VBGF_Ksp := c(0.05)]
W_lt_at_maturity <- 10^(-5.519 + log10(45) * 3.17882)
REco.params.LC$stanzas$stgroups[, Wmat     := c(1.8/32)] # weight at maturity / max weight? 

#Individual stanza parameters
REco.params.LC$stanzas$stindiv[, First   := c(0,4,24)]
REco.params.LC$stanzas$stindiv[,  Last    := c(3,23,400)]
REco.params.LC$stanzas$stindiv[,  Z       := c(M_fish$lake_trout_stk+0.1,
                                               M_fish$lake_trout_juv+0.1,
                                               M_fish$lake_trout_ad+0.1)] # Add 0.1 to see if it reduces the need for huge smelt and zoo biomass
REco.params.LC$stanzas$stindiv[,  Leading := c(T,F,F)]

```


```{r rebuild the eco param table}

REco.params.LC <- rpath.stanzas(REco.params.LC)

check.rpath.params(REco.params.LC)
```


```{r}
stanzaplot(REco.params.LC, StanzaGroup = 1, xlim=c(0,12*40))
# black: pop biomass
# green: number
# blue: individual weight
# red: stanza separation
```

#### Diet parameters

The data entered in the diet list is the same as the data entered in the diet composition tab in EwE. Just as within EwE, the columns represent the predators while the rows represent the prey. Individual diet components can be adjusted by specifying the prey in the ‘Group’ variable and assigning a value to the predator. For example, if I want to assign 10% of the lake trout diet as ‘smelt’, I would write:

```REco.params.LC$diet[Group == 'Smelt', 'Adult lake trout' := 0.1]```

```{r set diet}
# Sea Lamprey diet
REco.params.LC$diet[Group == 'Adult lake trout', 'Sea Lamprey' := 0.4]
REco.params.LC$diet[Group == 'Atlantic salmon', 'Sea Lamprey' := 0.4]
REco.params.LC$diet[Group == 'Burbot', 'Sea Lamprey' := 0.1]
REco.params.LC$diet[Group == 'Walleye', 'Sea Lamprey' := 0.05]
REco.params.LC$diet[Group == 'Whitefish', 'Sea Lamprey' := 0.05]

# Adult lake trout
REco.params.LC$diet[Group == 'Alewife', 'Adult lake trout' := 0.65]
REco.params.LC$diet[Group == 'Smelt', 'Adult lake trout' := 0.25]
REco.params.LC$diet[Group == 'Sculpin', 'Adult lake trout' := 0.1]

# Juvenile lake trout
REco.params.LC$diet[Group == 'Alewife', 'Juvenile lake trout' := 0.2]
REco.params.LC$diet[Group == 'Smelt', 'Juvenile lake trout' := 0.2]
REco.params.LC$diet[Group == 'Sculpin', 'Juvenile lake trout' := 0.2]
REco.params.LC$diet[Group == 'Mysis', 'Juvenile lake trout' := 0.3]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Juvenile lake trout' := 0.05]
REco.params.LC$diet[Group == 'Zoo grazers', 'Juvenile lake trout' := 0.05]

# Stocked lake trout
REco.params.LC$diet[Group == 'Mysis', 'Stocked lake trout' := 0.7]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Stocked lake trout' := 0.15]
REco.params.LC$diet[Group == 'Zoo grazers', 'Stocked lake trout' := 0.15]

# Atlantic salmon
REco.params.LC$diet[Group == 'Alewife', 'Atlantic salmon' := 0.5]
REco.params.LC$diet[Group == 'Smelt', 'Atlantic salmon' := 0.5]

# Burbot
REco.params.LC$diet[Group == 'Smelt', 'Burbot' := 0.3]
REco.params.LC$diet[Group == 'Sculpin', 'Burbot' := 0.2]
REco.params.LC$diet[Group == 'Benthic invertebrates', 'Burbot' := 0.5]

# Walleye
REco.params.LC$diet[Group == 'Smelt', 'Walleye' := 0.75]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Walleye' := 0.1]
REco.params.LC$diet[Group == 'Zoo grazers', 'Walleye' := 0.15]

# Whitefish
REco.params.LC$diet[Group == 'Smelt', 'Whitefish' := 0.2]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Whitefish' := 0.3]
REco.params.LC$diet[Group == 'Benthic invertebrates', 'Whitefish' := 0.5]

# Cisco
REco.params.LC$diet[Group == 'Smelt', 'Cisco' := 0.3]
REco.params.LC$diet[Group == 'Alewife', 'Cisco' := 0.3]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Cisco' := 0.2]
REco.params.LC$diet[Group == 'Benthic invertebrates', 'Cisco' := 0.2]

# Smelt
REco.params.LC$diet[Group == 'Zoo grazers', 'Smelt' := 0.4]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Smelt' := 0.3]
REco.params.LC$diet[Group == 'Smelt', 'Smelt' := 0.1]
REco.params.LC$diet[Group == 'Mysis', 'Smelt' := 0.2]

# Alewife
REco.params.LC$diet[Group == 'Zoo grazers', 'Alewife' := 0.7]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Alewife' := 0.3]

# Trout-perch
REco.params.LC$diet[Group == 'Benthic invertebrates', 'Trout-perch' := 0.3]
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Trout-perch' := 0.4]
REco.params.LC$diet[Group == 'Zoo grazers', 'Trout-perch' := 0.3]

# Sculpin
REco.params.LC$diet[Group == 'Mysis', 'Sculpin' := 0.5]
REco.params.LC$diet[Group == 'Benthic invertebrates', 'Sculpin' := 0.5]

# Zoo (predacious)
REco.params.LC$diet[Group == 'Zoo grazers', 'Zoo (predacious)' := 1]

# Mysis
REco.params.LC$diet[Group == 'Zoo (predacious)', 'Mysis' := 0.1]
REco.params.LC$diet[Group == 'Zoo grazers', 'Mysis' := 0.2]
REco.params.LC$diet[Group == 'Phytoplankton', 'Mysis' := 0.2]
REco.params.LC$diet[Group == 'Mysis', 'Mysis' := 0.1]
REco.params.LC$diet[Group == 'Detritus', 'Mysis' := 0.4]

# Benthic invertebrates
REco.params.LC$diet[Group == 'Phytoplankton', 'Benthic invertebrates' := 1]

# Zoo grazers
REco.params.LC$diet[Group == 'Phytoplankton', 'Zoo grazers' := 1]

# Diagnostic stats and plot for diet ####
### Make sure everything rounds up to 1 #
REco.params.LC$diet <- cbind(REco.params.LC$diet[,1],
  sapply( REco.params.LC$diet[,-1], function(x) x / sum(x, na.rm=T)))


###  Plot the diet to have a visual idea #
diet_melt <- melt(REco.params.LC$diet)
diet_melt <- diet_melt[!is.na(diet_melt$value),]
# Cumulative sum of diet to get label position
diet_melt <- ddply(diet_melt, "variable",
                   transform, label_ypos=1-cumsum(value))
diet_melt <- transform(diet_melt, Group_ID=as.numeric(factor(Group)))
id=as.numeric(factor(sample))
head(diet_melt)
diet_melt$Group_ID

ggplot(diet_melt,aes(variable, value, fill=Group)) + 
  geom_bar(stat="identity", colour=adjustcolor("white", alpha.f = .4)) +
  geom_text(aes(y=label_ypos, label=Group_ID), vjust=0, 
            color="white", size=2.5) +
  labs(x="Species", y="Diet proportion") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
 
```

##### Mixed trophic impact (Libralato et al 2006)

Given the mass-balance model of a trophic network, the mixed trophic impact is estimated for each pair of functional groups (i, j, interacting directly or not) of the trophic web, by means of the net impact matrix. According to Ulanowicz and Puccia (1990), the net impact of i on j ($q_{ij}$) is given by the difference between positive effects, quantified by the fraction of the prey i in the diet of the predator j ($d_{jj}$), and negative effects, evaluated through the fraction of total consumption of i used by predator j ($f_{ij}$). Therefore the resulting matrix of the net impacts, Q, has elements: <br>
$q_{ij}=d_{ji}−f_{ij}$ (2) <br>

The mixed trophic impact $m_{ij}$ is then estimated by the product of all the net impacts qij for all the possible pathways in the trophic web that link the functional groups i and j. Ulanowicz and Puccia (1990) demonstrated that the matrix of the mixed trophic impacts, M, can be obtained by the inverse of the matrix Q, as it is calculated in EwE (Christensen et al., 2004). Table 1 shows the elements of such matrix M derived from a food web representing the ecosystem off the coast of Newfoundland (Bundy, 2001). <br>
The elements mij of the matrix M quantify the direct and indirect impacts that each (impacting) group i has on any (impacted) group j of the food web (Ulanowicz and Puccia, 1990). Positive/negative values of $m_{ij}$ indicate the increase/decrease of biomass of the group j due to a slight increase of biomass of the impacting group i. Thus, the mixed trophic impacts represent the first order partial deriva- tives, in term of biomass, of the Ecopath master equation (1). This can be illustrated by Ecosim simulations, as shown below. <br>
Moreover, from Eq. (2) one can tell that negative elements of matrix M indicate a prevailing of negative effects, i.e. the effects of the predator on the prey; analogously, positive elements of M indicate prevailing effects of the prey on the predator. Therefore, negative elements of M can be associated to prevailing top-down effects and positive ones to bottom-up effects.
<br>

```{r mixed trophic impact calculation}
mdiet <- as.data.frame(REco.params.LC$diet)
mdiet[is.na(mdiet)] <- 0

# Net impact matrix
qmatrix <- mdiet
qmatrix[,-1] <- NA
# prey i
# predator j

for (j in 2:ncol(mdiet)) {
  for (i in 1:(nrow(mdiet)-2)) {
    # dji= positive effect, fraction of the prey i in the diet of the predator j
    # fij= negative effects, fraction of total consumption of i used by predator j
    #                  qij        =      dji    −     fij
    if(mdiet[i,j]>0) qmatrix[i,j] <- mdiet[i,j] - mdiet[i,j]/sum(mdiet[i,-1], na.rm=T)
  }
}

min(qmatrix[,-1], na.rm=T)
max(qmatrix[,-1], na.rm=T)
plot(colMeans(qmatrix[,-1], na.rm=T));abline(h=0)
plot(rowMeans(qmatrix[,-1], na.rm=T));abline(h=0)

# Mixed impact matrix
mmatrix <- mdiet
mmatrix[,-1] <- NA

# Using some code taken from package enaR, function enaMTI https://rdrr.io/cran/enaR/man/enaMTI.html
Flow <- mdiet[1:(ncol(mdiet)-1),-1]
I <- Flow * 0
diag(I) <- 1
Q <- qmatrix[1:(ncol(qmatrix)-1),-1]
Q[is.na(Q)] <- 0
dom1Q <- abs(eigen(Q)$values[1])
library(MASS)
M <- ginv(as.matrix(I) - as.matrix(Q)) - I

# code for relationalChange
# https://rdrr.io/github/SEELab/enaR/src/R/relationalChange.r
# r <- relationalChange(Q, M)
# IR <- r$Integral.Relations
# r.table <- r$Relations.Table
# names(r.table) <- c("From", "To", "Net (direct)", 
#                 "Mixed (integral)", "changed")
# rownames(r.table) <- c(1:dim(r.table)[1])

level_order <- c('Sea Lamprey', 'Adult lake trout','Juvenile lake trout', 'Stocked lake trout', 'Atlantic salmon', 'Burbot', 'Walleye', 'Whitefish', 'Cisco', 'Smelt', 'Alewife', 'Trout-perch', 'Sculpin', 'Zoo (predacious)', 'Mysis', 'Benthic invertebrates', 'Zoo grazers', 'Phytoplankton')

mmatrix <- data.frame("prey" = rep(colnames(M), nrow(M)),melt(M))

head(mmatrix[order(mmatrix$value, decreasing = T),])

p1 <- ggplot(mmatrix, aes(factor(prey, level=level_order), factor(variable, level=rev(level_order)), fill= value)) +geom_tile() +
  labs(x="impacting", y="impacted", subtitle = "Mixed trophic impact matrix", fill="Indirect effects") + theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  scale_fill_gradient2(midpoint=0,  low="red", mid="white",
                  high="blue")
p1
ggsave(paste0(getwd(),"/Output/Figures/6-Rpath/MixedTrophicImpactMatrix_LChamplain.pdf"), width = 6.36, height = 5.12, plot = p1)


# Index of keystoneness

# Pi = contribution of the functional group to the total biomass of the food web  
Pi <- REco2$BB[1:ncol(M)]/sum(REco2$BB[1:ncol(M)])
Pi <- Pi[order(REco2$Group[1:ncol(M)])]

# epsilon i = measure of the overall effect of each group i
epsi <- rep(NA, nrow(M))
for(i in 1:nrow(M)) {
  epsi[i] <- sum(M[i,-i]^2)
  epsi[i] <- sqrt(epsi[i])
}
epsi <- epsi[order(level_order)]
  
KSi = log(epsi*(1 - Pi))

KSi <- data.frame("Group"= level_order[order(level_order)],
           "Pi" = Pi,
           "epsi" = epsi,
           "KSi"= KSi)

KSi <- KSi[order(KSi$KSi),]

ggplot(KSi, aes(factor(Group, level=rev(level_order)), KSi)) + geom_point() +
  theme_bw() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) 

```

```{r}
library(enaR)
data(troModels)
mti <- enaMTI(troModels[[6]])
attributes(mti)
mti$M
mti$G
mti$FP
mti$Q

enaMTI

```


### Run ecopath

```{r}
REco.params.LC$model[Group %in% c('Phytoplankton'), Biomass := 700*9000]

REco2 <- rpath(REco.params.LC, eco.name = 'Lake Champlain')
REco2$BB

sum(REco2$TL[REco2$type<2] * REco2$BB[REco2$type<2]) / sum(REco2$BB[REco2$type<2])
plot(REco2$TL[REco2$type<2][order(REco2$TL[REco2$type<2])],REco2$BB[REco2$type<2][order(REco2$TL[REco2$type<2])], type="l")
plot(density(REco2$TL[REco2$type<2]* REco2$BB[REco2$type<2], )$y, type="l")

data.frame(REco2$Group,REco2$BB)
REco.params$model
REco.params.LC$model
REco2$QB
REco2$BB
REco.params.LC$model$QB
```

You can also display the mortalities associated with each group by supplying the argument morts = T to the print function.

```{r}
print(REco2, morts = T)
```


```{r}
summary(REco2)
REco2$TL # trophic level

summary(REco1)
summary(REco2)
sum(REco.params.LC$model$Biomass,na.rm=T)
```


```{r}
webplot(REco2)
if (!R_U_KNITTING) pdf(paste0(getwd(),"/Output/Figures/6-Rpath/Rpath_output.pdf"))
webplot(REco2, fleets = F, highlight = 'Mysis',labels = T)
webplot(REco2, fleets = F, highlight = 'Adult lake trout',labels = T)
if (!R_U_KNITTING) dev.off()

webplot(REco2, fleets = F, highlight = 'Phytoplankton')

```


```{r some diagnosis plot}
#Some plot output
REco2_df <- data.frame("Group"= REco2$Group,"BB"=REco2$BB, "TL"=REco2$TL)
REco2_df$summary <- ifelse(REco2_df$BB > 0, "Positive biomass", "Negative biomass")
REco2_df$Group <- factor(REco2_df$Group,levels = c(REco2$Group))

ggplot(REco2_df[-which(REco2_df$Group=="Detritus"),],aes(Group,BB, fill=summary)) +
  geom_bar(stat = "identity") +
  theme_bw() + labs(y="Biomass", fill='') + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(REco2_df[-which(REco2_df$Group=="Detritus"),],aes(Group,log(BB))) +
  geom_bar(stat = "identity") +
  theme_bw() + labs(y="log Biomass", fill='') + theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplot(REco2_df[-which(REco2_df$Group=="Detritus"),],aes(TL,log(BB), label = Group)) + 
  geom_point() +
  geom_text(hjust = 0, nudge_x = 0.05) + 
  stat_smooth()


```


```{r do pretty webplot}
# Get the diet data
ewediet_w <- as.data.frame(REco.params.LC$diet[-which(REco.params.LC$diet$Group=="Import"),])
ewediet_w[is.na(ewediet_w)] <- 0

# Reshape and remove rows with no interactions (prey-predator == 0)
ewediet2_w <- melt(ewediet_w)
colnames(ewediet2_w) <- c("prey","predator","weigth")
ewediet2_w <- ewediet2_w[ewediet2_w[,3]>0,]

# Use trophic level to get the y location on the graph
ewediet_nodes_w <- data.frame(
  "id"=as.character(REco2$Group),
  "level"=-REco2$TL
)
# remove the fleets (type == 3)
ewediet_nodes_w <- ewediet_nodes_w[REco2$type!=3,]
# order
#ewediet_nodes_w <- ewediet_nodes_w[order(ewediet_nodes_w$level),]

# Create the graph
net_w <- graph_from_data_frame(d=ewediet2_w, vertices=ewediet_nodes_w, directed=T) 

#set colors
colrs <- wes_palette("Darjeeling1", n=length(V(net_w)$name), type="continuous")
colrs <- colrs[order(ewediet_nodes_w$level)]
V(net_w)$color <- colrs

# Set some graphical parameters
edge.start <- ends(net_w, es=E(net_w), names=F)[,2]
edge.col <- V(net_w)$color[edge.start]

E(net_w)$weight <- as.numeric(paste(ewediet2_w$weigth))
E(net_w)$width <- as.numeric(paste(E(net_w)$weight))*7

# Set x positionning
ewediet_nodes_w$x <- rep(NA, nrow(ewediet_nodes_w))
for(i in unique(round(ewediet_nodes_w$level))) {
  le <- length(ewediet_nodes_w$x[round(ewediet_nodes_w$level)==i]) 
  if(le==1) ewediet_nodes_w$x[round(ewediet_nodes_w$level)==i] = 0
  if(le==2) ewediet_nodes_w$x[round(ewediet_nodes_w$level)==i] <- seq(-2,2, length.out = le) 
  if(le>2) ewediet_nodes_w$x[round(ewediet_nodes_w$level)==i] <- sample(seq(-4,4, length.out = le), size = le, replace = F)
}

ewediet_nodes_w$x2 <- 3

mylayout_w <- matrix(c(ewediet_nodes_w$x,ewediet_nodes_w$level,ewediet_nodes_w$x2),ncol=3)

E(net_w)$label <- paste0(round(as.numeric(paste(E(net_w)$weight)),2), "\n")
E(net_w)$label <- NA

V(net_w)$label <- paste0(ewediet_nodes_w$id,"\n")
V(net_w)$label <- NA

webplot(REco2, highlight = "Adult lake trout")

# size of dots scaled to biomass
vertex.size <- abs(REco2$BB)
vertex.size <- vertex.size / sqrt(sum(vertex.size^2)) 
vertex.size <- 10 #right now just leave it fixed

if(!R_U_KNITTING) pdf(paste0(getwd(),"/Output/Figures/6-Rpath/summary_interaction1.pdf"),width = 6, height = 6)
par(mar=c(1,4,0,5))
par(xpd=T)
plot.igraph(net_w,edge.color=adjustcolor(edge.col,alpha.f = .8), edge.curved=.1,
                  layout=-as.matrix(mylayout_w)[,1:2],vertex.size=vertex.size)
mticks <- approx(x=c(min(abs(ewediet_nodes_w$level)),
                     max(abs(ewediet_nodes_w$level))),
       y=c(-1,1), xout = pretty(abs(ewediet_nodes_w$level)))$y
axis(2, at=mticks, labels = pretty(abs(ewediet_nodes_w$level)))
mtext("Trophic level",2, line = 2.2)
par(xpd=F)
abline(h=mticks, lwd=.3, col=adjustcolor("black", alpha.f = .4), lty=2)
par(xpd=T)
TeachingDemos::shadowtext(-norm_coords(mylayout_w[,1:2], -1, 1, -1, 1), label=seq_along(ewediet_nodes_w$id),col="black",bg = "white",  theta = (1:8/4)*pi, cex=.7)
par(xpd=T)
legend(x=.8, y=-.25, paste(seq_along(ewediet_nodes_w$id), ewediet_nodes_w$id, sep=": "), pch=21,col="#777777", pt.bg=colrs, pt.cex=1, cex=.8, bty="n", ncol=1)
par(xpd=F)


if(!R_U_KNITTING) dev.off()
```


# R Ecosim

rsim.scenario: Prepares a balanced Rpath model and creates a scenario consisting of 5 list objects: params, start_state, forcing, fishing, and stanzas.


```{r}

Rp1 <- rsim.scenario(REco2, Rpath.params = REco.params.LC, years = 1:200)
Rs1 <- rsim.run(Rp1)

rsim.plot(Rs1, spname = Rp1$params$spname)


Rp1.1 <- adjust.forcing(Rp1, "byprey", group = "Zoo grazers", sim.year = 10:80, bymonth = F, value = 2)
Rs1.1 <- rsim.run(Rp1.1)

rsim.plot(Rs1.1, spname = Rp1$params$spname)


Rp1.2 <- adjust.forcing(Rp1, "byprey", group = "Cisco", sim.year = 10:80, bymonth = F, value = sample(seq(3,4,length.out = 30), size = 11))
Rs1.1 <- rsim.run(Rp1.1)

rsim.plot(Rs1.1, spname = Rp1$params$spname)


```


# Messy way to increase LT biomass to see how the relative biomass increase.

```{r Messy way to increase LT biomass to see how the relative biomass increase.}
ratios <- seq(-0.4,0.2,by=0.1)
output_LT_changes <- data.frame("Biomass_initial"= REco2$BB)#/REco2$BB)

for (i in ratios) {
  param_edits <- REco.params.LC
  
  #Edit stanzas
  #Group parameters
  param_edits$stanzas$stgroups[, VBGF_Ksp := c(0.05)]
  W_lt_at_maturity <- 10^(-5.519 + log10(45) * 3.17882)
  param_edits$stanzas$stgroups[, Wmat     := c(1.8/32)] # weight at maturity / max weight? 
  
  #Individual stanza parameters
  param_edits$stanzas$stindiv[, First   := c(0,4,24)]
  param_edits$stanzas$stindiv[,  Last    := c(3,23,400)]
  param_edits$stanzas$stindiv[,  Z       := c(M_fish$lake_trout_stk,
                                                 M_fish$lake_trout_juv+i,
                                                 M_fish$lake_trout_ad)] # Add 0.1 to see if it reduces the need for huge smelt and zoo biomass
  param_edits$stanzas$stindiv[,  Leading := c(T,F,F)]
  
   param_edits <- rpath.stanzas(param_edits)
  
  # param_edits$model[Group %in% c('Adult lake trout'), "Biomass"] <- REco.params.LC$model[Group %in% c('Adult lake trout'), Biomass]*i
  REco3 <- rpath(param_edits, eco.name = 'Lake Champlain')
  print(paste("Adult lake trout biomass:",
              REco2$BB[REco2$Group=='Adult lake trout'], " - ",
              REco3$BB[REco3$Group=='Adult lake trout']))
  
  output_LT_changes <- cbind(output_LT_changes, as.vector(REco3$BB))#/REco2$BB))

}
colnames(output_LT_changes) <-  c(0, ratios)
output_LT_changes <- output_LT_changes[,-1]
#output_LT_changes <- output_LT_changes/output_LT_changes[,which(colnames(output_LT_changes)=="0")]

output_LT_changes <- t(output_LT_changes)
colnames(output_LT_changes) <- REco2$Group


if(!R_U_KNITTING) pdf(paste0(getwd(),"/Output/Figures/6-Rpath/test_change_LT_biomass2.pdf"),width = 10, height = 10)
layout(matrix(1:ncol(output_LT_changes), ncol=4))
for (i in 1:(ncol(output_LT_changes)-1)) {
  plot(as.numeric(paste(rownames(output_LT_changes))),output_LT_changes[,i], type="l", main=paste(colnames(output_LT_changes)[i]), xlab="Change in mortality of juvenile lake trout", ylab=paste(colnames(output_LT_changes)[i],"biomass"))
  points(as.numeric(paste(rownames(output_LT_changes))),output_LT_changes[,i], pch=ifelse(output_LT_changes[,i]>=0, 16, 1), cex=2, col=c(rep("cyan2",4), "black","red", "red"))
}
if(!R_U_KNITTING) dev.off()

output_LT_changes_melt <- melt(output_LT_changes)

ggplot(output_LT_changes_melt, aes(Var1, value)) + geom_point() + facet_wrap(~Var2)

```

# Messy way to increase LT biomass to see how the relative biomass increase, by changing stocking.

```{r Messy way to increase LT biomass to see how the relative biomass increase, by changing stocking.}
ratios <- seq(65,125,by=10)
output_LT_changes <- data.frame("Biomass_initial"= REco2$BB)#/REco2$BB)

ggplot(data.frame("Index"=1:length(ratios),"Stocking"=ratios*1000, "type"=c("<","<","=",">",">",">",">")), aes(Index,Stocking, fill=type)) +
  geom_bar(stat = "identity") + geom_hline(yintercept = 85000) +
  labs(x="Scenarios", y="Equivalent yearling", title = "Different scenarios tested", fill="Comparison\nto present\nstocking")  + theme_bw() + scale_fill_manual(values = c("tomato","grey","deepskyblue2" ))
  

for (i in ratios) {
  param_edits <- REco.params.LC
   # Change the initial biomass
  param_edits$model[Group %in% c('Stocked lake trout'), Biomass := i]
  # And force some other biomass
  # param_edits$model[Group %in% c('Atlantic salmon'), Biomass := REco2$BB[REco2$Group=="Atlantic salmon"]]
  #   param_edits$model[Group %in% c('Burbot'), Biomass := REco2$BB[REco2$Group=="Burbot"]]
  # param_edits$model[Group %in% c('Sea Lamprey'), Biomass := REco2$BB[REco2$Group=="Sea Lamprey"]]
  param_edits$model[Group %in% c('Juvenile lake trout'), Biomass := NA]
  param_edits$model[Group %in% c('Adult lake trout'), Biomass := NA]
  
  #Edit stanzas
  #Group parameters
  param_edits$stanzas$stgroups[, VBGF_Ksp := c(0.05)]
  W_lt_at_maturity <- 10^(-5.519 + log10(45) * 3.17882)
  param_edits$stanzas$stgroups[, Wmat     := c(1.8/32)] # weight at maturity / max weight? 
  
  #Individual stanza parameters
  param_edits$stanzas$stindiv[, First   := c(0,4,24)]
  param_edits$stanzas$stindiv[,  Last    := c(3,23,400)]
  param_edits$stanzas$stindiv[,  Z       := c(M_fish$lake_trout_stk,
                                                 M_fish$lake_trout_juv,
                                                 M_fish$lake_trout_ad)] # Add 0.1 to see if it reduces the need for huge smelt and zoo biomass
  param_edits$stanzas$stindiv[,  Leading := c(T,F,F)]
  
 
   param_edits <- rpath.stanzas(param_edits)
  
  # param_edits$model[Group %in% c('Adult lake trout'), "Biomass"] <- REco.params.LC$model[Group %in% c('Adult lake trout'), Biomass]*i
  REco3 <- rpath(param_edits, eco.name = 'Lake Champlain')
  print(paste("Adult lake trout biomass:",
              REco2$BB[REco2$Group=='Adult lake trout'], " - ",
              REco3$BB[REco3$Group=='Adult lake trout']))
  
  output_LT_changes <- cbind(output_LT_changes, as.vector(REco3$BB))#/REco2$BB))

}
colnames(output_LT_changes) <-  c(0, ratios)
output_LT_changes <- output_LT_changes[,-1]
#output_LT_changes <- output_LT_changes/output_LT_changes[,which(colnames(output_LT_changes)=="0")]

output_LT_changes <- t(output_LT_changes)
colnames(output_LT_changes) <- REco2$Group


if(!R_U_KNITTING) pdf(paste0(getwd(),"/Output/Figures/6-Rpath/test_change_LT_biomass3.pdf"),width = 10, height = 10)
layout(matrix(1:ncol(output_LT_changes), ncol=4))
for (i in 1:(ncol(output_LT_changes)-1)) {
  plot(as.numeric(paste(rownames(output_LT_changes))),output_LT_changes[,i], type="l", main=paste(colnames(output_LT_changes)[i]), xlab="Change in biomass of stocked lake trout", ylab=paste(colnames(output_LT_changes)[i],"biomass"))
  points(as.numeric(paste(rownames(output_LT_changes))),output_LT_changes[,i], pch=ifelse(output_LT_changes[,i]>=0, 16, 1), cex=2, col=c(rep("tomato",2), "grey",rep("deepskyblue2",4)))
}
if(!R_U_KNITTING) dev.off()

output_LT_changes_melt <- melt(output_LT_changes)

ggplot(output_LT_changes_melt, aes(Var1, value)) + geom_point() + facet_wrap(~Var2)

```


# Messy way to balance LT biomass in response to higher natural recruitment.

```{r Messy way to balance LT biomass in response to higher natural recruitment.}
ratios <- seq(-0.3,-0.1,by=0.1)
stockingchange <- seq(85,30, by = -15)
output_LT_stock_mort_changes <- data.frame("Biomass_initial"= REco2$BB)#/REco2$BB)

for (i in ratios) {
  for (j in stockingchange) {
    param_edits <- REco.params.LC
  
  #Edit stanzas
  #Group parameters
  param_edits$stanzas$stgroups[, VBGF_Ksp := c(0.05)]
  W_lt_at_maturity <- 10^(-5.519 + log10(45) * 3.17882)
  param_edits$stanzas$stgroups[, Wmat     := c(1.8/32)] # weight at maturity / max weight? 
  
  #Individual stanza parameters
  param_edits$stanzas$stindiv[, First   := c(0,4,24)]
  param_edits$stanzas$stindiv[,  Last    := c(3,23,400)]
  param_edits$stanzas$stindiv[,  Z       := c(M_fish$lake_trout_stk,
                                                 M_fish$lake_trout_juv+i,
                                                 M_fish$lake_trout_ad)] # Add 0.1 to see if it reduces the need for huge smelt and zoo biomass
  param_edits$stanzas$stindiv[,  Leading := c(T,F,F)]
  
  # Change the initial biomass
  param_edits$model[Group %in% c('Stocked lake trout'), Biomass := j]
  
  param_edits <- rpath.stanzas(param_edits)
  
  # param_edits$model[Group %in% c('Adult lake trout'), "Biomass"] <- REco.params.LC$model[Group %in% c('Adult lake trout'), Biomass]*i
  REco3 <- rpath(param_edits, eco.name = 'Lake Champlain')
  print(paste("Adult lake trout biomass:",
              REco2$BB[REco2$Group=='Adult lake trout'], " - ",
              REco3$BB[REco3$Group=='Adult lake trout']))
  
  output_LT_stock_mort_changes <- cbind(output_LT_stock_mort_changes, as.vector(REco3$BB))#/REco2$BB))
  }

}
colnames(output_LT_stock_mort_changes) <-  c( paste(rep(ratios, each=length(stockingchange)),c(85,rep(stockingchange, length(ratios))), sep="_"))
output_LT_stock_mort_changes <- output_LT_stock_mort_changes[,-1]
#output_LT_stock_mort_changes <- output_LT_stock_mort_changes/output_LT_stock_mort_changes[,which(colnames(output_LT_stock_mort_changes)=="0")]

output_LT_stock_mort_changes <- t(output_LT_stock_mort_changes)
colnames(output_LT_stock_mort_changes) <- REco2$Group


if(!R_U_KNITTING) pdf(paste0(getwd(),"/Output/Figures/6-Rpath/test_change_LT_biomass_stocking_biomass.pdf"),width = 10, height = 10)
layout(matrix(1:ncol(output_LT_changes), ncol=4))
for (i in 1:(ncol(output_LT_changes)-1)) {
  plot(rep(ratios, each=length(stockingchange)),output_LT_changes[,i], type="l", main=paste(colnames(output_LT_changes)[i]), xlab="Change in mortality of juvenile lake trout", ylab=paste(colnames(output_LT_changes)[i],"biomass"))
  points(as.numeric(paste(rownames(output_LT_changes))),output_LT_changes[,i], pch=ifelse(output_LT_changes[,i]>=0, 16, 1), cex=2, col=c(rep("cyan2",4), "black","red", "red"))
}
if(!R_U_KNITTING) dev.off()

output_LT_changes_melt <- melt(output_LT_changes)

ggplot(output_LT_changes_melt, aes(Var1, value)) + geom_point() + facet_wrap(~Var2)

```




# transfer energy trophic level (Hive plot)

```{r hive plot}
#library HiveR not working
#library(HiveR)

#Tweak using igraph
plot.igraph(net_w,edge.color=adjustcolor(edge.col,alpha.f = .8), edge.curved=2,
                  layout=-as.matrix(matrix(c(rep(0,nrow(mylayout_w)),mylayout_w[,2]), ncol=2),vertex.size=vertex.size))



tl <- data.frame("Group" = REco2$Group, "TL" = REco2$TL)

hive1 <- edge2HPD(edge_df = dataSet.ext)
```

