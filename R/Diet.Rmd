---
title: "Lake Trout Diet Analysis"
author: "Alex Naccarato"
date: "5/14/2019"
output: html_document
---

## The Basics

I always have to include the code for my libraries so everything functions properly. In addition, I'm reading in the data file I'll be using for the analysis. I'm also getting rid of two outliers. They were very long fish that were quite skinny. 

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(ggplot2)
library(binr)
library(matrixStats)
library(Rmisc)
library(gmodels)

LTdata <- read.csv("/Users/alexnaccarato/Desktop/Food-Web 2018-2019/LCM_GitHub_Data/data_from_Pascal/LT_2016-2018.csv")

LTdata$Weight[LTdata$Weight < 3000 & LTdata$Total.Length > 750] <- NA
LTdata$Total.Length[LTdata$Weight < 3000 & LTdata$Total.Length > 750] <- NA
```

## Relationship Between Length and Weight, Separated by Age

Here, I'm creating a scatterplot of the weight of the fish by their length. I included a filter for age to see how this relationship varies by age. In addition, I included a log-transformed version of this plot. 

```{r age, warning=FALSE}
LTdata %>% ggplot(mapping = aes(x = Total.Length,
                                y = Weight, 
                                color = Age)) +
  geom_point() +
  labs(x = "Total Length (mm)", y = "Weight (g)") +
  geom_smooth(method = "loess", color = "black")

LTdata %>%  ggplot(mapping = aes(x = Total.Length, 
                                 y = Weight,
                                 color = Age)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Total Length (mm)", y = "Weight (g)") +
  geom_smooth(method = "lm", color = "black")
```

## Relationship Between Length and Weight, Separated by Clip Location

Here, I'm creating another scatterplot of the weight/length relationship for lake trout, but included the location of the clip as a filter. I also included a log-transformed version of this plot.

```{r cliplocation, warning=FALSE}
LTdata %>% ggplot(mapping = aes(x = Total.Length,
                                y = Weight, 
                                color = Clip.Location)) +
  geom_point() +
  labs(x = "Total Length (mm)", y = "Weight (g)", color = "Clip Location") +
  geom_smooth(method = "loess", color = "black")

LTdata %>%  ggplot(mapping = aes(x = Total.Length, 
                                 y = Weight,
                                 color = Clip.Location)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Total Length (mm)", y = "Weight (g)", color = "Clip Location") +
  geom_smooth(method = "lm", color = "black")
```

## Length and Weight Relationship between Stocked and Wild Lake Trout

Stocked trout are typically larger than wild fish. They often have longer lengths and greater weights than wild fish. I show these comparisons later on with bar plots. 

```{r stocked, warning = FALSE}
LTdata %>% mutate(group = case_when(Clip.Location == "NC" ~ "Wild",
                                    Clip.Location == "AD" ~ "Stocked",
                                    Clip.Location == "LP" ~ "Stocked",
                                    Clip.Location == "LV" ~ "Stocked",
                                    Clip.Location == "LV*" ~ "Stocked",
                                    Clip.Location == "LVRV" ~ "Stocked",
                                    Clip.Location == "RP" ~ "Stocked",
                                    Clip.Location == "RV" ~ "Stocked")) %>% 
  ggplot(mapping = aes(x = Total.Length,
                                y = Weight, 
                                color = group)) +
  geom_point() +
  labs(x = "Total Length (mm)", y = "Weight (g)", color = "Clip Location") +
  geom_smooth(method = "loess", color = "black")

# First, I'm classifying the stocked vs. wild lake trout based on the presence/absence of a fin clip.
LTdata %>% mutate(group = case_when(Clip.Location == "NC" ~ "Wild",
                                    Clip.Location == "AD" ~ "Stocked",
                                    Clip.Location == "LP" ~ "Stocked",
                                    Clip.Location == "LV" ~ "Stocked",
                                    Clip.Location == "LV*" ~ "Stocked",
                                    Clip.Location == "LVRV" ~ "Stocked",
                                    Clip.Location == "RP" ~ "Stocked",
                                    Clip.Location == "RV" ~ "Stocked")) %>% 
  ggplot(mapping = aes(x = Total.Length,
                       y = Weight, 
                       color = group)) +
  geom_point() +
  labs(x = "Total Length (mm)", y = "Weight (g)", color = "Clip Location") +
  geom_smooth(method = "loess", color = "black") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Total Length (mm)", y = "Weight (g)", color = "Clip Location") +
  geom_smooth(method = "lm", color = "black")
```

## Proportion of Empty Stomachs For Each Length Class

Here, I'm creating a bar chart of the proportion of empty stomachs size classes of lake trout. It appears that the likelihood of finding a trout with an empty stomach is more likely in older fish. 

```{r empty.by.lengthclass}
# I'm just making categories for the size classes here.
LTdata <- LTdata  %>% mutate(size_class = case_when(
  Total.Length <= 100 ~ "[0,100]",
  Total.Length > 100 & Total.Length <= 200 ~ "]100,200]", 
  Total.Length > 200 & Total.Length <= 300 ~ "]200,300]",
  Total.Length > 300 & Total.Length <= 400 ~ "]300,400]",
  Total.Length > 400 & Total.Length <= 500 ~ "]400,500]",
  Total.Length > 500 ~ "]500,âˆž]"))

# I'm recoding some variables because they weren't consistent. I recoded "T" to "Y", because I was assuming it was a typo. 
# T and Y are right next to each other on the keyboard.
LTdata$Food.in.Stomach[LTdata$Food.in.Stomach == "no"] <- "N"
LTdata$Food.in.Stomach[LTdata$Food.in.Stomach == "yes"] <- "Y"
LTdata$Food.in.Stomach[LTdata$Food.in.Stomach == "T"] <- "Y"

# Here, we're finding the counts of Y and N for each size class. 
(summ_sc <- with(LTdata, tapply(rep(1,nrow(LTdata)),list("Size class" = size_class, "Food" = Food.in.Stomach), sum)))

# This is where we convert the counts to percentages. 
(summ_sc <- as.data.frame(summ_sc / rowSums(summ_sc, na.rm=T) * 100))

# Creating the plot for the percentages empty stomachs for the size classes. 
ggplot(data = summ_sc, aes(x = rownames(summ_sc),y = summ_sc[,1])) +
  geom_bar(stat = "identity") + xlab("Size Class") + ylab("Percentage of Empty Stomachs")

# This is a function that will round your value (in this case, x) to your base. User can input the value 'x' and the 'base'.
# If the value is positive, it will round up to the ceiling of your base. If the value is negative, it will round down to the floor of your base. 
mround <- function(x, base)
{
  if (x>0) base*ceiling(x/base) else base*floor(x/base)
}

# Here, we're applying the function to the vector of lake trout lengths and retrieving their new size classifications. 
LTdata$size_class_HR <- mround(LTdata$Total.Length, 10)

# The end goal for this little chunk of code is to get the percentages of Y and N for each new size category we just created. 
summ_sc_hr <- with(LTdata, tapply(rep(1,nrow(LTdata)),list("Size class HR" = size_class_HR, "Food" = Food.in.Stomach), sum))
summ_sc_hr <- as.data.frame(summ_sc_hr / rowSums(summ_sc_hr, na.rm=T) * 100)
summ_sc_hr <- summ_sc_hr[,colSums(summ_sc_hr,na.rm=T)>0]

# We are creating a plot of the 'running' t-test p-values. On the y-axis situated on the left, you'll see the log of the
# p-value. On the y-axis situated on the right, you'll see the p-value for each of the individual t-tests. 
myseq <- seq(80, 700, 10)
for(i in myseq) {
  if(i == myseq[1]) myoutput<-NULL
  smaller <- summ_sc_hr[as.numeric(rownames(summ_sc_hr)) <= i,'N']
  larger <- summ_sc_hr[as.numeric(rownames(summ_sc_hr)) > i,'N']
  myoutput<- c(myoutput,t.test(larger,smaller)$p.value)
}
plot(myseq,log(myoutput),axes=F)
axis(1)
axis(2)
axis(4, at=seq(min(log(myoutput)), max(log(myoutput)), length=5), labels = round(exp(seq(min(log(myoutput)), max(log(myoutput)), length=5)),4))

# Are these next two lines of code still neccessary?
str(t.test(larger,smaller))

t.test(larger,smaller)$p.value

```

## Lake Trout Diet by Length

The relationship between the size of stomachs and the length of the fish is not well summarized by a linear model. 

```{r stomach.weight.by.length, warning=FALSE}
LTdata %>% ggplot(mapping = aes(x = Total.Length, y = as.numeric(Stomach.Weight))) +
  geom_point() + 
  xlab("Length (mm)") + 
  ylab("Stomach Weight (g)") +
  stat_smooth(method = "lm") 
```

## Lake Trout Diet by Weight

The relationship between the size of the stomachs and the weight of the fish is not well summarized by a linear model. 

```{r stomach.weight.by.weight, warning=FALSE}
LTdata %>% ggplot(mapping = aes(x = Weight, y = as.numeric(Stomach.Weight))) +
  geom_point() + 
  xlab("Length (mm)") + 
  ylab("Stomach Weight (g)") +
  stat_smooth(method = "lm") 
```

## Lake Trout Stomach Weight by Month

```{r stomach.weight.by.capture.month}
LTdata$Capture.Month[LTdata$Capture.Month == 4] <- "April"
LTdata$Capture.Month[LTdata$Capture.Month == 5] <- "May"
LTdata$Capture.Month[LTdata$Capture.Month == 6] <- "June"
LTdata$Capture.Month[LTdata$Capture.Month == 7] <- "July"
LTdata$Capture.Month[LTdata$Capture.Month == 8] <- "August"
LTdata$Capture.Month[LTdata$Capture.Month == 9] <- "September"
LTdata$Capture.Month[LTdata$Capture.Month == 10] <- "October"
LTdata$Capture.Month[LTdata$Capture.Month == 11] <- "November"

LTdata %>% ggplot(mapping = aes(x = Capture.Month, y = as.numeric(paste(Stomach.Weight)), fill = Capture.Month)) +
  geom_boxplot() +
  xlab("Capture Location") +
  ylab("Stomach Weight (g)") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_discrete()
```

## Lake Trout Length by Nativity

Stocked lake trout (n = 1129) tend to be much longer than wild lake trout (n = 1135). In fact, a 95% confidence interval suggests the true difference in mean length between stocked and wild lake trout lies between 103.7 and 120.1 mm. The difference is statistically significant, as indicated by the very low p-value of 2.2e-16.

```{r length.by.origin, warning=FALSE}
LTdata$stock.wild <- ifelse(LTdata$Clip.Location == "NC", "Wild", "Stocked")

LTdata %>% ggplot(mapping = aes(x = stock.wild, y = Total.Length, fill = stock.wild)) +
  geom_bar(stat = "summary", fun.y = "mean") +
  labs(y = "Average Total Length (mm)", fill = "") +
  theme(axis.title.x = element_blank()) 

t.test(LTdata$Total.Length ~ LTdata$stock.wild)

(num.wild <- length(LTdata$stock.wild[LTdata$stock.wild == "Wild"]))
(num.stocked <- length(LTdata$stock.wild[LTdata$stock.wild == "Stocked"]))
```

## Lake Trout Weight by Nativity

Stocked lake trout (n = 1129) tend to be much heavier than wild lake trout (n = 1135). We are 95% confident that the true difference in mean weight between stocked and wild lake trout is between 220.5 and 306.0 g (p = 2.2e-16).

```{r weight.by.origin, warning=FALSE}
LTdata %>% ggplot(mapping = aes(x = stock.wild, y = Weight, fill = stock.wild)) +
  geom_bar(stat = "summary", fun.y = "mean") +
  labs(y = "Average Weight (g)", fill = "") +
  theme(axis.title.x = element_blank()) 

t.test(LTdata$Weight ~ LTdata$stock.wild)
```

